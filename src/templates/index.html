<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Disease Classifier</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>

<div class="main-container">

    <header class="header">
        <h1><svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="currentColor" class="bi bi-leaf" viewBox="0 0 16 16" style="color: var(--primary-green);"><path d="M8.414.166a.5.5 0 0 1 .293.293l5 10a.5.5 0 0 1-.894.448L8 6.012 2.187 15.804a.5.5 0 0 1-.894-.448l5-10a.5.5 0 0 1 .293-.293zM8 5.412a.5.5 0 0 1 .5.5V10a.5.5 0 0 1-1 0V5.912a.5.5 0 0 1 .5-.5z"/></svg> Plant Disease Classifier</h1>
        <p>AI-powered plant health analysis with personalized treatment recommendations</p>
    </header>

    <div id="uploader-card" class="card uploader-card">
        <h2><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-camera" viewBox="0 0 16 16"><path d="M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1v6zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2z"/><path d="M8 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5zm0 1a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7zM3 6.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0z"/></svg> Upload Plant Image</h2>
        <p>Upload a photo of your plant for disease analysis</p>
        <input type="file" id="file-input" class="hidden" accept="image/*">
        <div id="drop-zone">
            <div id="image-preview-container" class="hidden">
                <img id="image-preview" src="" alt="Image Preview">
                <button id="remove-image-btn" title="Remove Image">&times;</button>
            </div>
            <div id="upload-prompt">
                <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="currentColor" class="bi bi-cloud-arrow-up" viewBox="0 0 16 16" style="color: #ccc;"><path fill-rule="evenodd" d="M7.646 5.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 6.707V10.5a.5.5 0 0 1-1 0V6.707L6.354 7.854a.5.5 0 1 1-.708-.708l2-2z"/><path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383zm.653.757c-.757.653-1.153 1.44-1.153 2.056v.448l-.445.049C2.064 6.805 1 7.952 1 9.318 1 10.785 2.23 12 3.781 12h8.906C13.98 12 15 10.988 15 9.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 4.825 10.328 3 8 3a4.53 4.53 0 0 0-2.941 1.1z"/></svg>
                <p>Drop your image here, or click to browse</p>
            </div>
        </div>
        <button id="analyze-btn" class="btn">Analyze Plant</button>
    </div>

    <div id="loader" class="loader hidden"></div>

    <div id="analysis-result-card" class="card hidden">
        <h2><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16" style="color: var(--primary-green);"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/></svg> Analysis Result</h2>
        <p><strong>Detected Condition:</strong> <span id="disease-name"></span></p>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span>Prediction Confidence</span>
            <span id="confidence-badge" class="confidence-badge"></span>
        </div>
        <div class="progress-bar-container">
            <div id="confidence-progress"></div>
        </div>
        <div class="result-summary">
            <p id="result-summary-text"></p>
        </div>
        <button id="get-recommendations-btn" class="btn">Get Treatment Recommendations</button>
        <button id="analyze-another-btn-1" class="btn btn-secondary">Analyze Another Plant</button>
    </div>

    <div id="recommendations-container" class="hidden">
        <div class="card recommendation-card">
            <div>
                <div class="recommendation-header">
                    <h3 class="recommendation-title">Immediate Actions</h3>
                    <span class="tag urgent">Urgent</span>
                </div>
                <ul id="immediate-actions-list" class="recommendation-list"></ul>
            </div>
            <div>
                <div class="recommendation-header">
                    <h3 class="recommendation-title">Preventive Measures</h3>
                    <span class="tag prevention">Prevention</span>
                </div>
                <ul id="preventive-measures-list" class="recommendation-list"></ul>
            </div>
            <div>
                <div class="recommendation-header">
                    <h3 class="recommendation-title">Long-Term Solutions</h3>
                    <span class="tag long-term">Long-Term</span>
                </div>
                <ul id="long-term-solutions-list" class="recommendation-list"></ul>
            </div>
        </div>
        <div class="button-group">
            <button id="back-to-analysis-btn" class="btn btn-secondary">Back to Analysis</button>
            <button id="analyze-another-btn-2" class="btn">Analyze Another Plant</button>
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById('file-input');
    const dropZone = document.getElementById('drop-zone');
    const uploadPrompt = document.getElementById('upload-prompt');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const removeImageBtn = document.getElementById('remove-image-btn');
    const analyzeBtn = document.getElementById('analyze-btn');
    const uploaderCard = document.getElementById('uploader-card');
    const loader = document.getElementById('loader');
    const analysisResultCard = document.getElementById('analysis-result-card');
    const recommendationsContainer = document.getElementById('recommendations-container');
    const getRecommendationsBtn = document.getElementById('get-recommendations-btn');
    const diseaseName = document.getElementById('disease-name');
    const confidenceBadge = document.getElementById('confidence-badge');
    const confidenceProgress = document.getElementById('confidence-progress');
    const resultSummaryText = document.getElementById('result-summary-text');
    const immediateList = document.getElementById('immediate-actions-list');
    const preventiveList = document.getElementById('preventive-measures-list');
    const longTermList = document.getElementById('long-term-solutions-list');
    const analyzeAnotherBtn1 = document.getElementById('analyze-another-btn-1');
    const backToAnalysisBtn = document.getElementById('back-to-analysis-btn');
    const analyzeAnotherBtn2 = document.getElementById('analyze-another-btn-2');

    let selectedFile = null;
    let apiResultData = null;

    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => handleFile(fileInput.files[0]));
    removeImageBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        resetUploader();
    });
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.classList.remove('dragover'); });
    dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
    });

    function handleFile(file) {
        if (file && file.type.startsWith('image/')) {
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = e => imagePreview.src = e.target.result;
            reader.readAsDataURL(file);
            imagePreviewContainer.classList.remove('hidden');
            uploadPrompt.classList.add('hidden');
        }
    }

    function resetUploader() {
        selectedFile = null;
        apiResultData = null;
        fileInput.value = '';
        imagePreviewContainer.classList.add('hidden');
        uploadPrompt.classList.remove('hidden');
    }

    function startOver() {
        resetUploader();
        uploaderCard.classList.remove('hidden');
        analysisResultCard.classList.add('hidden');
        recommendationsContainer.classList.add('hidden');
    }

    analyzeBtn.addEventListener('click', async () => {
        if (!selectedFile) {
            alert("Please upload an image first!");
            return;
        }
        const formData = new FormData();
        formData.append('file', selectedFile);
        const API_URL = 'http://127.0.0.1:5000/predict';
        uploaderCard.classList.add('hidden');
        loader.classList.remove('hidden');
        try {
            const response = await fetch(API_URL, { method: 'POST', body: formData });
            if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
            apiResultData = await response.json();
            displayAnalysisResult(apiResultData);
        } catch (error) {
            console.error('API Error:', error);
            alert(`Failed to analyze plant. Please ensure the server is running and accessible.`);
            startOver();
        } finally {
            loader.classList.add('hidden');
        }
    });

    function displayAnalysisResult(data) {
        diseaseName.textContent = data.disease;
        const confidence = parseFloat(data.confidence) || 0;
        confidenceBadge.textContent = `${confidence}% Confidence`;
        confidenceProgress.style.width = `${confidence}%`;

        const specialCases = ["Not a Plant", "Unrecognized Condition"];
        const isSpecialCase = specialCases.includes(data.disease);
        const isHealthy = data.disease.toLowerCase().includes('healthy');

        if (isSpecialCase) {
            resultSummaryText.textContent = data.care_plan;
            getRecommendationsBtn.classList.add('hidden');
        } else if (isHealthy) {
            resultSummaryText.textContent = "Your plant appears to be in good health. Continue with your current care routine.";
            getRecommendationsBtn.classList.add('hidden');
        } else {
            resultSummaryText.textContent = `The analysis indicates your plant may have ${data.disease}. Click the button below for a detailed care plan.`;
            getRecommendationsBtn.classList.remove('hidden');
        }
        analysisResultCard.classList.remove('hidden');
    }

    getRecommendationsBtn.addEventListener('click', () => {
        if (!apiResultData) return;
        analysisResultCard.classList.add('hidden');
        parseAndDisplayRecommendations(apiResultData.care_plan);
        recommendationsContainer.classList.remove('hidden');
    });

    function parseAndDisplayRecommendations(carePlan) {
        immediateList.innerHTML = '';
        preventiveList.innerHTML = '';
        longTermList.innerHTML = '';
        const sections = {
            'Immediate Actions': immediateList,
            'Preventive Measures': preventiveList,
            'Long-Term Solutions': longTermList
        };
        let currentList = null;
        const lines = carePlan.split('\n');

        lines.forEach(line => {
            line = line.trim();
            if (!line) return;
            if (line.includes('### Immediate Actions')) {
                currentList = sections['Immediate Actions'];
            } else if (line.includes('### Preventive Measures')) {
                currentList = sections['Preventive Measures'];
            } else if (line.includes('### Long-Term Solutions')) {
                currentList = sections['Long-Term Solutions'];
            } else if (line.startsWith('-') && currentList) {
                const li = document.createElement('li');
                li.textContent = line.substring(1).trim();
                currentList.appendChild(li);
            }
        });
    }

    analyzeAnotherBtn1.addEventListener('click', startOver);
    analyzeAnotherBtn2.addEventListener('click', startOver);
    backToAnalysisBtn.addEventListener('click', () => {
        recommendationsContainer.classList.add('hidden');
        analysisResultCard.classList.remove('hidden');
    });
</script>

</body>
</html>